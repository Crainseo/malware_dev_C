#define _CRT_SECURE_NO_WARNINGS

#include <Windows.h>
#include <bcrypt.h>
#include <stdio.h>

#pragma comment (lib, "bcrypt.lib")

#define newBufferSize 8192  // 더 큰 버퍼 크기로 변경

// 함수를 호출하기 위한 예제 코드입니다.
int main() {
    BCRYPT_ALG_HANDLE hAlgorithm = NULL;
    BCRYPT_KEY_HANDLE hKey = NULL;

    // DES 알고리즘 공급자 열기
    if (BCryptOpenAlgorithmProvider(&hAlgorithm, BCRYPT_DES_ALGORITHM, NULL, 0) != 0) {
        printf("BCryptOpenAlgorithmProvider 실패\n");
        return 1;
    }

    // 키 생성
    UCHAR keyData[8] = { 0x00, 0x11, 0x22, 0x33, 0x44, 0x55, 0x66, 0x77 };
    if (BCryptGenerateSymmetricKey(hAlgorithm, &hKey, NULL, 0, keyData, sizeof(keyData), 0) != 0) {
        printf("BCryptGenerateSymmetricKey 실패\n");
        BCryptCloseAlgorithmProvider(hAlgorithm, 0);
        return 1;
    }

    // 파일 열기
    FILE* inputFile = fopen("C:\\Users\\Owner\\Documents\\test\\1.txt", "rb");
    if (inputFile == NULL) {
        printf("파일 열기 실패\n");
        BCryptDestroyKey(hKey);
        BCryptCloseAlgorithmProvider(hAlgorithm, 0);
        return 1;
    }

    FILE* outputFile = fopen("C:\\Users\\Owner\\Documents\\test\\1.mulffler", "wb");
    if (outputFile == NULL) {
        printf("파일 열기 실패\n");
        fclose(inputFile);
        BCryptDestroyKey(hKey);
        BCryptCloseAlgorithmProvider(hAlgorithm, 0);
        return 1;
    }

    // 데이터 암호화
    BYTE buffer[newBufferSize];
    DWORD bytesRead;

    while (1) {
        bytesRead = fread(buffer, 1, newBufferSize, inputFile);
        if (bytesRead == 0) {
            break;  // 파일 끝에 도달
        }

        if (BCryptEncrypt(hKey, buffer, bytesRead, NULL, NULL, NULL, 0, buffer, bytesRead, &bytesRead, 0) != 0) {
            printf("BCryptEncrypt 실패, 오류 코드: 0x%08X\n", GetLastError());
            fclose(inputFile);
            fclose(outputFile);
            BCryptDestroyKey(hKey);
            BCryptCloseAlgorithmProvider(hAlgorithm, 0);
            return 1;
        }

        fwrite(buffer, 1, bytesRead, outputFile);
    }

    // 파일 닫기
    fclose(inputFile);
    fclose(outputFile);

    // 자원 해제
    BCryptDestroyKey(hKey);
    BCryptCloseAlgorithmProvider(hAlgorithm, 0);

    printf("암호화 완료\n");
    return 0;
}
